<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flipbook Viewer</title>

  <style>
    :root{
      --bg:#f7f3ea; --ink:#2b2b2b; --brand:#254B4F; --brand-ink:#F5E9D8; --panel:#ffffff;
      --zoom:1;  /* 확대 배율 (CSS transform) */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%;}
    header{display:flex;align-items:center;gap:.75rem;padding:.5rem .75rem;background:var(--panel);border-bottom:1px solid #e7e2d7;position:sticky;top:0;z-index:5}
    header .logo{display:flex;align-items:center;gap:.5rem}
    header img.logo-img{height:28px;width:auto;object-fit:contain}
    header .brand{font-weight:700}
    .toolbar{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-left:auto}
    .btn{border:1px solid #ddd;background:#fff;padding:.45rem .65rem;border-radius:.5rem;cursor:pointer}
    .btn.brand{background:var(--brand);color:var(--brand-ink);border-color:transparent}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-toggle{display:inline-flex;align-items:center;gap:.35rem}
    .sep{width:1px;height:28px;background:#e4ded2;margin:0 .25rem}

    .viewer-wrap{display:grid;grid-template-columns:260px 1fr; gap:0; height:100%; min-height:0}
    .viewer-wrap.toc-hidden{grid-template-columns:0 1fr}
    nav#toc{overflow:auto;border-right:1px solid #eadfcd;background:#fcfbf7}
    nav#toc h3{margin:.75rem 1rem .25rem;font-size:.95rem;color:#6e5f46}
    nav#toc ul{list-style:none;margin:0;padding:.25rem .5rem .75rem}
    nav#toc li{padding:.25rem .5rem}
    nav#toc a{color:var(--ink);text-decoration:none;font-size:.9rem}
    nav#toc a:hover{color:var(--brand)}

    .stage{position:relative;overflow:auto;background:linear-gradient(45deg, rgba(0,0,0,.02), rgba(0,0,0,.06)); display:grid; place-items:center}
    #zoomWrap{transform:scale(var(--zoom)); transform-origin:center center; transition:transform .15s ease;}
    #flipbook{width:min(92vw,1100px);height:min(80vh, 880px);}
    .page-preloader{position:absolute;inset:0;display:grid;place-items:center;color:#6b6b6b;font-size:.95rem;background:transparent}
    .stf__block{box-shadow:0 10px 40px rgba(0,0,0,.10)}
    .hint{font-size:.8rem;color:#6f6f6f;margin-left:.5rem}
    .fullscreen{background:var(--bg)}
    @media (max-width:900px){ .viewer-wrap{grid-template-columns: 0 1fr} }
  </style>

  <!-- PDF.js: 로컬 우선, CDN 폴백 -->
  <script>
  (function(){
    function loadScript(src, ok, bad){var s=document.createElement('script');s.src=src;s.onload=ok;s.onerror=bad||function(){};document.head.appendChild(s);}
    function okLocal(){ if(window.pdfjsLib){ pdfjsLib.GlobalWorkerOptions.workerSrc='./libs/pdf.worker.min.js'; window.__pdfjsReady=true; } }
    function okCdn(){ if(window.pdfjsLib){ pdfjsLib.GlobalWorkerOptions.workerSrc='https://esm.run/pdfjs-dist@4.8.69/build/pdf.worker.min.js'; window.__pdfjsReady=true; } }

    loadScript('./libs/pdf.min.js', okLocal, function(){
      console.warn('Local PDF.js not found → CDN');
      loadScript('https://esm.run/pdfjs-dist@4.8.69/build/pdf.min.js', okCdn, function(){ console.error('PDF.js load failed'); });
    });
  })();
  </script>

  <!-- PageFlip: 로컬 우선, CDN 폴백 -->
  <link id="pf-css" rel="stylesheet" href="./libs/stpageflip.min.css">
  <script>
  (function(){
    function loadScript(src, ok, bad){var s=document.createElement('script');s.src=src;s.onload=ok;s.onerror=bad||function(){};document.head.appendChild(s);}
    loadScript('./libs/stpageflip.min.js', function(){ window.__pageflipReady = !!(window.St && St.PageFlip); }, function(){
      console.warn('Local PageFlip not found → CDN');
      var css = document.getElementById('pf-css'); css && (css.href='https://cdn.jsdelivr.net/npm/stpageflip@2.0.7/dist/css/stpageflip.min.css');
      loadScript('https://cdn.jsdelivr.net/npm/stpageflip@2.0.7/dist/js/stpageflip.min.js', function(){ window.__pageflipReady = !!(window.St && St.PageFlip); }, function(){ console.error('PageFlip load failed'); });
    });
  })();
  </script>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <img class="logo-img" src="./assets/logo.png" alt="logo" onerror="this.style.display='none'">
      <div class="brand">Flipbook</div>
    </div>
    <div class="toolbar">
      <label>파일:
        <select id="fileSelect" class="btn"></select>
      </label>
      <button id="prevBtn" class="btn" title="이전 페이지" disabled>◀</button>
      <button id="nextBtn" class="btn" title="다음 페이지" disabled>▶</button>
      <span id="pageLabel" class="hint">- / -</span>
      <span class="sep"></span>
      <button id="zoomOut" class="btn" title="축소">－</button>
      <button id="zoomIn" class="btn" title="확대">＋</button>
      <button id="fitBtn" class="btn" title="화면맞춤">맞춤</button>
      <span class="sep"></span>
      <button id="fsBtn" class="btn brand" title="전체화면">⛶</button>
      <label class="btn btn-toggle"><input type="checkbox" id="tocToggle" checked> 목차</label>
      <label class="btn btn-toggle"><input type="checkbox" id="disableDl"> 다운로드 비활성화</label>
    </div>
  </header>

  <div class="viewer-wrap" id="viewerWrap">
    <nav id="toc"><h3>목차</h3><ul id="tocList"></ul></nav>
    <main class="stage" id="stage">
      <div id="zoomWrap">
        <div id="flipbook"></div>
      </div>
      <div class="page-preloader" id="preloader">페이지 준비 중…</div>
    </main>
  </div>
</div>

<script>
(function(){
const state = {
  pdf:null, total:0, pages:[],        // pages[i] = {img:HTMLElement|null, rendering:false}
  current:1, manifest:[], disableDownload:false,
  flip:null, zoom:1, minZoom:0.75, maxZoom:2.5,
  ready:false,                         // ← 준비 완료 플래그(버튼 활성화 제어)
  audioCtx:null                        // ← 효과음
};

const $ = id => document.getElementById(id);
const fileSelect = $("fileSelect"), pageLabel = $("pageLabel"), preloader = $("preloader");
const tocList = $("tocList"), tocToggle = $("tocToggle"), viewerWrap = $("viewerWrap");
const prevBtn = $("prevBtn"), nextBtn = $("nextBtn");

function waitFlag(flag){ return new Promise((res,rej)=>{ let t=0,iv=setInterval(()=>{ if(window[flag]){clearInterval(iv);res();} if(++t>80){clearInterval(iv);rej(new Error(flag+' timeout'));} },100); }); }
function fetchJSON(url){ return fetch(url).then(r=>{ if(!r.ok) throw new Error('JSON 실패'); return r.json();}); }
function getQuery(name){ const u=new URL(location.href); return u.searchParams.get(name); }

async function initFiles(){
  await waitFlag('__pdfjsReady');       // PDF.js 준비
  const q = getQuery('file');
  try{ state.manifest = await fetchJSON('./ebooks/manifest.json'); } catch{ state.manifest=[]; }
  fileSelect.innerHTML=''; const ph=document.createElement('option'); ph.value=''; ph.textContent='파일을 선택하세요'; fileSelect.appendChild(ph);
  state.manifest.forEach(it=>{ const o=document.createElement('option'); o.value=it.url; o.textContent=it.title||it.url.split('/').pop(); fileSelect.appendChild(o); });
  if(q){ await loadPDF(q); } else if(state.manifest[0]){ fileSelect.value=state.manifest[0].url; await loadPDF(state.manifest[0].url); }
}
fileSelect.addEventListener('change', e=>{ if(e.target.value) loadPDF(e.target.value); });

/* 효과음: 짧은 whoosh */
function playFlipSound(){
  try{
    if(!state.audioCtx) state.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const ctx = state.audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(420, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(220, ctx.currentTime+0.12);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.16);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.18);
  }catch(e){}
}

async function loadPDF(url){
  state.ready=false; setButtons(false);    // 초기화 동안 버튼 잠금
  cleanupFlip(); preloader.hidden=false; pageLabel.textContent='- / -'; tocList.innerHTML='';
  const task = pdfjsLib.getDocument({url}); state.pdf = await task.promise; state.total = state.pdf.numPages;
  state.pages = Array.from({length:state.total}, ()=>({img:null, rendering:false})); state.current = 1; pageLabel.textContent=`1 / ${state.total}`;

  try{
    const outline = await state.pdf.getOutline();
    if(outline?.length){ buildTOC(outline); tocToggle.checked=true; viewerWrap.classList.remove('toc-hidden'); }
    else { tocToggle.checked=false; viewerWrap.classList.add('toc-hidden'); }
  }catch{}

  await waitPageFlip();                   // PageFlip 있든 없든 대기(폴백 포함)
  initFlip();

  // 첫 두 페이지 미리 렌더 → 주입 → 준비 완료
  await ensureRendered(1);
  if(state.total>=2) await ensureRendered(2);
  feedFlipInitial();
  preloader.hidden=true;
  state.ready=true; setButtons(true);
}

function setButtons(on){
  prevBtn.disabled = !on;
  nextBtn.disabled = !on;
}

function buildTOC(outline){
  tocList.innerHTML=''; const root=document.createElement('ul'); tocList.appendChild(root);
  const walk=(items,ul)=>{
    items.forEach(async item=>{
      const li=document.createElement('li'); const a=document.createElement('a');
      a.textContent=item.title||'제목 없음'; a.href='#';
      a.addEventListener('click',async e=>{
        e.preventDefault();
        const dest=await state.pdf.getDestination(item.dest);
        const pageIndex = dest?.[0]?.num ? dest[0].num : (dest?.[0]?.pageNumber || 1);
        goTo(pageIndex);
      });
      li.appendChild(a); ul.appendChild(li);
      if(item.items?.length){ const child=document.createElement('ul'); li.appendChild(child); walk(item.items, child); }
    });
  };
  walk(outline, root);
}
tocToggle.addEventListener('change',()=> viewerWrap.classList.toggle('toc-hidden', !tocToggle.checked));

function waitPageFlip(){ return new Promise(res=>{ let t=0,iv=setInterval(()=>{ if(window.St?.PageFlip){clearInterval(iv);res();} if(++t>80){clearInterval(iv);res();} },100); }); }

function initFlip(){
  const container = $("flipbook"); container.innerHTML='';
  if(window.St?.PageFlip){
    state.flip = new St.PageFlip(container, {
      width:520, height:720, size:'stretch',
      maxShadowOpacity:0.2, showCover:false,
      useMouseEvents:true, flippingTime:600,
      drawShadow:true, autoSize:true,
    });
    state.flip.on('flip', async (e)=>{
      state.current = e.data; pageLabel.textContent=`${state.current} / ${state.total}`;
      const around=[state.current-2,state.current-1,state.current+1,state.current+2].filter(n=>n>=1 && n<=state.total);
      for(const p of around) await ensureRendered(p);
      playFlipSound();
    });
  } else {
    // 폴백: 세로 나열
    state.flip = null;
    container.innerHTML = '<div id="linear"></div>';
  }
}

/* 한 번만 고해상도 렌더 → 이미지 캐시 (확대/축소는 CSS만 변경) */
async function ensureRendered(pageNumber){
  const slot = state.pages[pageNumber-1]; if(slot.img || slot.rendering) return; slot.rendering=true;

  const page = await state.pdf.getPage(pageNumber);
  const viewport = page.getViewport({scale:1});
  const container=$("flipbook");

  const basis = Math.min((container.clientWidth/2)/viewport.width, container.clientHeight/viewport.height);
  const renderScale = Math.max(1.2, basis * (window.devicePixelRatio||1));  // 고해상도
  const v2 = page.getViewport({scale:renderScale});

  const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{alpha:false});
  canvas.width=Math.floor(v2.width); canvas.height=Math.floor(v2.height);
  await page.render({canvasContext:ctx, viewport:v2, intent:'display'}).promise;

  // 링크 레이어
  const annotations = await page.getAnnotations();
  const wrapper=document.createElement('div'); Object.assign(wrapper.style,{position:'relative', width:v2.width+'px', height:v2.height+'px'});
  const img=new Image(); img.src=canvas.toDataURL('image/jpeg', 0.92); img.draggable=false; Object.assign(img.style,{width:'100%',height:'100%',userSelect:'none'}); wrapper.appendChild(img);

  const linkLayer=document.createElement('div'); Object.assign(linkLayer.style,{position:'absolute', inset:'0', pointerEvents: state.disableDownload?'none':'auto'}); wrapper.appendChild(linkLayer);
  const transform = pdfjsLib.Util.transform; const view = page.view; const viewportTransform = v2.transform;
  annotations.filter(a=>a.subtype==='Link' && a.rect).forEach(a=>{
    let rect = pdfjsLib.Util.normalizeRect(a.rect);
    let m = transform(viewportTransform, [1,0,0,-1,0,v2.height]);
    let p1 = pdfjsLib.Util.applyTransform([rect[0],rect[1]], m);
    let p2 = pdfjsLib.Util.applyTransform([rect[2],rect[3]], m);
    const left=Math.min(p1[0],p2[0]), top=Math.min(p1[1],p2[1]), width=Math.abs(p1[0]-p2[0]), height=Math.abs(p1[1]-p2[1]);
    const link=document.createElement('a'); link.href=a.url||'#'; link.target='_blank'; link.rel='noopener'; Object.assign(link.style,{position:'absolute',left:left+'px',top:top+'px',width:width+'px',height:height+'px',display:'block',background:'rgba(0,0,0,0)'}); linkLayer.appendChild(link);
  });

  slot.img = wrapper; slot.rendering=false;
}

/* 초기 주입: Flip/폴백 공용 */
function feedFlipInitial(){
  const flipEl = $("flipbook");
  if (flipEl.querySelector('#linear')) {
    const linear = flipEl.querySelector('#linear');
    linear.style.display='grid'; linear.style.placeItems='center';
    for(let i=1;i<=state.total;i++){
      const slot = state.pages[i-1]; if(!slot?.img) continue;
      const holder=document.createElement('div'); holder.style.margin='12px'; holder.appendChild(slot.img); linear.appendChild(holder);
    }
  } else {
    const nodes=[];
    for(let i=1;i<=Math.min(4,state.total);i++){
      const slot = state.pages[i-1]; if(!slot?.img) continue;
      const node=document.createElement('div'); node.className='page'; node.appendChild(slot.img); nodes.push(node);
    }
    if(nodes.length) state.flip.loadFromHTML(nodes);
  }
}

function cleanupFlip(){
  const c=$("flipbook");
  if(state.flip && state.flip.destroy) try{state.flip.destroy();}catch(e){}
  c.innerHTML=''; state.flip=null;
}

/* 페이지 이동(준비 전엔 무시) */
function goTo(n){
  if(!state.ready) return;                 // ← 준비 끝나기 전엔 동작 금지
  n=Math.max(1, Math.min(state.total, n));
  const isLinear = !!document.querySelector('#flipbook #linear');
  if(isLinear){
    const pages = Array.from(document.querySelectorAll('#flipbook #linear > div'));
    const target = pages[n-1]; if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
    state.current=n; pageLabel.textContent=`${state.current} / ${state.total}`;
    playFlipSound();
    return;
  }
  if(state.flip?.flip){ state.flip.flip(n); }   // flip 이벤트에서 사운드/라벨 처리
}

prevBtn.onclick = ()=> goTo(state.current-1);
nextBtn.onclick = ()=> goTo(state.current+1);

/* 확대/축소/맞춤: CSS 스케일만 변경 (재렌더/재초기화 금지) */
function applyZoom(){ document.documentElement.style.setProperty('--zoom', String(state.zoom)); }
$("zoomIn").onclick = ()=>{ state.zoom=Math.min(state.maxZoom, +(state.zoom+0.15).toFixed(2)); applyZoom(); };
$("zoomOut").onclick = ()=>{ state.zoom=Math.max(state.minZoom, +(state.zoom-0.15).toFixed(2)); applyZoom(); };
$("fitBtn").onclick   = ()=>{ state.zoom=1; applyZoom(); };

$("fsBtn").onclick = ()=>{ const el = document.documentElement; if(!document.fullscreenElement){ el.requestFullscreen?.(); document.body.classList.add('fullscreen'); } else { document.exitFullscreen?.(); document.body.classList.remove('fullscreen'); } };

$("disableDl").addEventListener('change',(e)=>{ state.disableDownload=e.target.checked; document.addEventListener('contextmenu', blockCtx, {capture:true}); if(!state.disableDownload){ document.removeEventListener('contextmenu', blockCtx, {capture:true}); } });
function blockCtx(ev){ if(state.disableDownload) ev.preventDefault(); }

/* 키보드 이동 */
document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight') nextBtn.click();
  if(e.key==='ArrowLeft')  prevBtn.click();
});

initFiles();
})();
</script>
</body>
</html>
